<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PENX - Handwriting & Drawing App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js library for PDF import support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
            touch-action: none;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
            overflow: auto;
            position: relative;
            cursor: crosshair;
        }
        canvas {
            display: block;
            background-color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin: 40px auto;
            transform-origin: top center;
        }
        .toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 999px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 100;
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .toolbar.hidden-bar {
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            pointer-events: none;
        }
        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
        }
        .tool-btn:hover {
            background: #e5e7eb;
        }
        .tool-btn.active {
            background: #3b82f6;
            color: white;
        }
        .side-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 90;
            width: 220px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        .side-panel.hidden-panel {
            transform: translateX(250px);
            opacity: 0;
            pointer-events: none;
        }
        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-dot.active {
            border-color: #3b82f6;
            transform: scale(1.1);
        }
        /* Paper Templates Styles */
        .paper-lined {
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 100% 30px;
        }
        .paper-grid {
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .paper-dotted {
            background-image: radial-gradient(#d1d5db 1px, transparent 1px);
            background-size: 30px 30px;
        }
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }
        /* Toggle View Button */
        .focus-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 110;
            background: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .focus-toggle:hover {
            background: #f9fafb;
        }

        /* Loading Spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="toast">Message</div>

<!-- Focus Toggle Button -->
<div class="focus-toggle" id="focusToggle" title="Toggle Focus Mode">
    <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
        <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
        <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
    </svg>
</div>

<!-- Top Left Brand -->
<div class="fixed top-6 left-6 z-50 flex items-center gap-3">
    <div class="bg-blue-600 text-white p-2 rounded-lg font-bold shadow-lg">P</div>
    <h1 class="text-xl font-bold text-gray-800" id="brandTitle">PENX</h1>
</div>

<!-- Side Panel for Settings -->
<div class="side-panel" id="sidePanel">
    <label class="block text-sm font-medium text-gray-700 mb-2 mt-12">Paper Template</label>
    <select id="templateSelect" class="w-full p-2 border rounded-md text-sm mb-4">
        <option value="blank">Blank Paper</option>
        <option value="lined">Lined Paper</option>
        <option value="grid">Grid Paper</option>
        <option value="dotted">Dotted Paper</option>
    </select>

    <label class="block text-sm font-medium text-gray-700 mb-2">Brush Size</label>
    <input type="range" id="brushSize" min="1" max="50" value="3" class="w-full mb-4">

    <label class="block text-sm font-medium text-gray-700 mb-2">Brush Style</label>
    <select id="brushStyle" class="w-full p-2 border rounded-md text-sm mb-4">
        <option value="round">Standard Pen</option>
        <option value="butt">Flat Brush</option>
        <option value="square">Marker</option>
        <option value="pencil">Pencil (Textured)</option>
    </select>

    <div class="flex flex-wrap gap-2 mb-4" id="colorPalette">
        <div class="color-dot active" style="background: #000000" data-color="#000000"></div>
        <div class="color-dot" style="background: #ef4444" data-color="#ef4444"></div>
        <div class="color-dot" style="background: #3b82f6" data-color="#3b82f6"></div>
        <div class="color-dot" style="background: #10b981" data-color="#10b981"></div>
        <div class="color-dot" style="background: #f59e0b" data-color="#f59e0b"></div>
        <div class="color-dot" style="background: #8b5cf6" data-color="#8b5cf6"></div>
        <input type="color" id="customColor" class="w-6 h-6 p-0 border-none bg-transparent cursor-pointer">
    </div>

    <div class="space-y-2 mb-4">
        <button id="analyzeBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-2 rounded-md text-sm font-medium transition flex items-center justify-center gap-2 shadow-sm">
            <span>✨ Smart Analyze</span>
            <div id="analyzeLoader" class="spinner hidden"></div>
        </button>
        
        <div class="relative">
            <input type="text" id="imageGenPrompt" placeholder="Describe an image..." class="w-full p-2 border rounded-md text-xs mb-1">
            <button id="generateImageBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-md text-sm font-medium transition flex items-center justify-center gap-2">
                <span>✨ Generate Image</span>
                <div id="genLoader" class="spinner hidden"></div>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-2 mb-2">
        <button id="importBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-md text-[10px] font-bold transition flex flex-col items-center justify-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
            </svg>
            IMAGES/PDF
        </button>
        <button id="importFolderBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-md text-[10px] font-bold transition flex flex-col items-center justify-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"/>
            </svg>
            FOLDER
        </button>
    </div>
    
    <input type="file" id="fileInput" accept="image/*,.pdf" class="hidden">
    <input type="file" id="folderInput" webkitdirectory directory multiple class="hidden">
</div>

<!-- Main Canvas Area -->
<div id="canvas-container">
    <canvas id="mainCanvas"></canvas>
</div>

<!-- Bottom Toolbar -->
<div class="toolbar" id="mainToolbar">
    <button class="tool-btn active" id="penTool" title="Pen">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
        </svg>
    </button>
    <button class="tool-btn" id="eraserTool" title="Eraser">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828l6.879-6.879zm2.121.707a1 1 0 0 0-1.414 0L4.16 7.547l5.293 5.293 4.633-4.633a1 1 0 0 0 0-1.414l-3.879-3.879zM8.746 13.414l-6.308-6.308L1.732 7.81a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293h2.793a1 1 0 0 0 .707-.293l.307-.307z"/>
        </svg>
    </button>
    <div class="h-6 w-px bg-gray-300"></div>
    <button class="tool-btn" id="clearBtn" title="Clear Canvas">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
        </svg>
    </button>
    <button class="tool-btn" id="downloadBtn" title="Download as Image">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
    </button>
</div>

<!-- Modal for AI Results -->
<div id="aiModal" class="fixed inset-0 bg-black/50 hidden z-[200] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-lg w-full p-6 shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">✨ PENX Insight</h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <div id="modalContent" class="text-gray-600 leading-relaxed whitespace-pre-wrap"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-container');
    const brushSizeInput = document.getElementById('brushSize');
    const brushStyleInput = document.getElementById('brushStyle');
    const colorDots = document.querySelectorAll('.color-dot');
    const customColorInput = document.getElementById('customColor');
    const templateSelect = document.getElementById('templateSelect');
    const fileInput = document.getElementById('fileInput');
    const folderInput = document.getElementById('folderInput');
    const importBtn = document.getElementById('importBtn');
    const importFolderBtn = document.getElementById('importFolderBtn');
    const penTool = document.getElementById('penTool');
    const eraserTool = document.getElementById('eraserTool');
    const clearBtn = document.getElementById('clearBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const toast = document.getElementById('toast');
    
    // Configure PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Focus Toggle Elements
    const focusToggle = document.getElementById('focusToggle');
    const sidePanel = document.getElementById('sidePanel');
    const mainToolbar = document.getElementById('mainToolbar');
    const brandTitle = document.getElementById('brandTitle');
    const eyeIcon = document.getElementById('eyeIcon');

    // AI Elements
    const apiKey = ""; // Provided by environment
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeLoader = document.getElementById('analyzeLoader');
    const generateImageBtn = document.getElementById('generateImageBtn');
    const genLoader = document.getElementById('genLoader');
    const imageGenPrompt = document.getElementById('imageGenPrompt');
    const aiModal = document.getElementById('aiModal');
    const modalContent = document.getElementById('modalContent');
    const closeModal = document.getElementById('closeModal');

    // App State
    let isDrawing = false;
    let currentTool = 'pen';
    let currentColor = '#000000';
    let currentSize = 3;
    let lastX = 0;
    let lastY = 0;
    let isFocusMode = false;

    // Initialize Canvas Size
    function initCanvas() {
        canvas.width = 2000;
        canvas.height = 4000;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = currentSize;
        container.scrollLeft = (canvas.width - window.innerWidth) / 2;
    }

    function showToast(msg) {
        toast.innerText = msg;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 2000);
    }

    // --- AI Feature: Analyze Canvas Content ---
    async function analyzeCanvas() {
        if (analyzeLoader.classList.contains('hidden') === false) return;
        
        analyzeLoader.classList.remove('hidden');
        try {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = 800;
            tempCanvas.height = 800;
            
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0,0,800,800);
            tempCtx.drawImage(canvas, 0, 0, 800, 800);
            
            const base64Image = tempCanvas.toDataURL('image/png').split(',')[1];
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: "Look at this handwriting or drawing. Transcribe any text you see, explain the diagram, or provide creative feedback on the artistic style. Be encouraging and helpful." },
                            { inlineData: { mimeType: "image/png", data: base64Image } }
                        ]
                    }]
                })
            });

            const data = await response.json();
            const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't understand that.";
            
            modalContent.innerText = resultText;
            aiModal.classList.remove('hidden');
        } catch (err) {
            showToast("PENX analysis failed.");
            console.error(err);
        } finally {
            analyzeLoader.classList.add('hidden');
        }
    }

    // --- AI Feature: Generate Image ---
    async function generateImage() {
        const prompt = imageGenPrompt.value.trim();
        if (!prompt) {
            showToast("Please describe an image first.");
            return;
        }
        
        genLoader.classList.remove('hidden');
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    instances: { prompt: prompt },
                    parameters: { sampleCount: 1 }
                })
            });

            const data = await response.json();
            const imageUrl = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
            
            const img = new Image();
            img.onload = () => {
                const x = container.scrollLeft + (window.innerWidth / 4);
                const y = container.scrollTop + (window.innerHeight / 4);
                ctx.globalCompositeOperation = 'source-over';
                ctx.drawImage(img, x, y, 400, 400); 
                showToast("✨ AI Image Added!");
                imageGenPrompt.value = "";
            };
            img.src = imageUrl;
        } catch (err) {
            showToast("Image generation failed.");
            console.error(err);
        } finally {
            genLoader.classList.add('hidden');
        }
    }

    // Toggle Focus Mode
    focusToggle.addEventListener('click', () => {
        isFocusMode = !isFocusMode;
        
        if (isFocusMode) {
            sidePanel.classList.add('hidden-panel');
            mainToolbar.classList.add('hidden-bar');
            brandTitle.style.opacity = '0.3';
            eyeIcon.innerHTML = `
                <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/>
                <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-4.743 1.233-1.507 1.507a7.041 7.041 0 0 1-2.903-3.633l.812-.812c.1.204.204.4.321.592.428.7.94 1.232 1.587 1.634.285.177.592.312.91.405l.78.783zm6.172 2.259a.5.5 0 0 0 .708-.708l-11-11a.5.5 0 1 0-.708.708l11 11z"/>
            `;
            showToast("Focus Mode On");
        } else {
            sidePanel.classList.remove('hidden-panel');
            mainToolbar.classList.remove('hidden-bar');
            brandTitle.style.opacity = '1';
            eyeIcon.innerHTML = `
                <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
            `;
            showToast("Focus Mode Off");
        }
    });

    // Drawing Logic
    function startDrawing(e) {
        if (e.target !== canvas) return;
        isDrawing = true;
        const pos = getMousePos(e);
        [lastX, lastY] = [pos.x, pos.y];
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getMousePos(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);

        if (currentTool === 'eraser') {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.lineWidth = brushSizeInput.value * 2;
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSizeInput.value;
            ctx.lineCap = brushStyleInput.value;
            if (brushStyleInput.value === 'pencil') {
                ctx.globalAlpha = 0.5;
                const jitter = (Math.random() - 0.5) * 2;
                ctx.lineWidth = Math.max(1, brushSizeInput.value + jitter);
            } else {
                ctx.globalAlpha = 1.0;
            }
        }
        ctx.stroke();
        [lastX, lastY] = [pos.x, pos.y];
    }

    function stopDrawing() { isDrawing = false; }

    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    // UI Listeners
    colorDots.forEach(dot => {
        dot.addEventListener('click', () => {
            colorDots.forEach(d => d.classList.remove('active'));
            dot.classList.add('active');
            currentColor = dot.dataset.color;
            setTool('pen');
        });
    });

    customColorInput.addEventListener('input', (e) => {
        currentColor = e.target.value;
        setTool('pen');
    });

    templateSelect.addEventListener('change', (e) => {
        canvas.className = '';
        if (e.target.value !== 'blank') canvas.classList.add('paper-' + e.target.value);
    });

    function setTool(tool) {
        currentTool = tool;
        penTool.classList.remove('active');
        eraserTool.classList.remove('active');
        if (tool === 'pen') penTool.classList.add('active');
        if (tool === 'eraser') eraserTool.classList.add('active');
    }

    penTool.addEventListener('click', () => setTool('pen'));
    eraserTool.addEventListener('click', () => setTool('eraser'));
    clearBtn.addEventListener('click', () => {
        if (confirm('Clear entire canvas?')) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            showToast('Canvas cleared');
        }
    });

    downloadBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'penx-note.png';
        link.href = canvas.toDataURL();
        link.click();
        showToast('Drawing downloaded');
    });

    // Helper: Draw Image onto Canvas with Layout
    function drawImageAtPos(img, x, y) {
        const maxW = 800; // Increased width for PDF pages
        const scale = Math.min(1, maxW / img.width);
        ctx.globalCompositeOperation = 'source-over';
        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
        return img.height * scale; // Return calculated height for vertical layout
    }

    // PDF Import Handler
    async function handlePdfFile(file) {
        showToast("Processing PDF...");
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const typedArray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedArray).promise;
            
            let currentX = container.scrollLeft + 100;
            let currentY = container.scrollTop + 100;
            const pageSpacing = 40;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                
                // Render PDF page to a temporary canvas
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.height = viewport.height;
                tempCanvas.width = viewport.width;

                await page.render({
                    canvasContext: tempCtx,
                    viewport: viewport
                }).promise;

                // Draw that temporary canvas as an image onto our main canvas
                const img = new Image();
                img.onload = () => {
                    const renderedHeight = drawImageAtPos(img, currentX, currentY);
                    currentY += renderedHeight + pageSpacing; // Layout pages vertically
                };
                img.src = tempCanvas.toDataURL();
            }
            showToast(`Imported ${pdf.numPages} PDF pages`);
        };
        fileReader.readAsArrayBuffer(file);
    }

    // Image Import Handler
    function handleImageFile(file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const x = container.scrollLeft + (window.innerWidth / 4);
                const y = container.scrollTop + (window.innerHeight / 4);
                drawImageAtPos(img, x, y);
                showToast('Image imported');
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    // Unified File Import
    importBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.type === "application/pdf") {
            handlePdfFile(file);
        } else {
            handleImageFile(file);
        }
    });

    // Folder Import
    importFolderBtn.addEventListener('click', () => folderInput.click());
    folderInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files).filter(file => 
            file.type.startsWith('image/') || /\.(jpg|jpeg|png|webp)$/i.test(file.name)
        );
        
        if (files.length === 0) {
            showToast("No images found in folder");
            return;
        }

        showToast(`Importing ${files.length} images...`);
        
        let currentX = container.scrollLeft + 50;
        let currentY = container.scrollTop + 100;
        const spacing = 450;
        const rowWidthLimit = canvas.width - 500;

        for (const file of files) {
            await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        drawImageAtPos(img, currentX, currentY);
                        currentX += spacing;
                        if (currentX > rowWidthLimit) {
                            currentX = container.scrollLeft + 50;
                            currentY += spacing;
                        }
                        resolve();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        showToast("Folder import complete");
    });

    // AI Button Bindings
    analyzeBtn.addEventListener('click', analyzeCanvas);
    generateImageBtn.addEventListener('click', generateImage);
    closeModal.addEventListener('click', () => aiModal.classList.add('hidden'));

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    window.addEventListener('touchend', stopDrawing);

    window.onload = initCanvas;
</script>

</body>
</html>
